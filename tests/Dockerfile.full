# Full deployment test: Ubuntu 24.04 + Nix + home-manager
# Validates complete home-manager activation on a production-like environment.

FROM ubuntu:24.04

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update -qq && \
    apt-get install -y -qq --no-install-recommends \
        curl xz-utils ca-certificates git sudo \
    && rm -rf /var/lib/apt/lists/*

ARG TEST_USER=testuser
RUN useradd -m -s /bin/bash ${TEST_USER}

RUN mkdir -p /nix && chown ${TEST_USER} /nix
USER ${TEST_USER}
ENV USER=${TEST_USER}
RUN curl -L https://nixos.org/nix/install | bash -s -- --no-daemon

ENV PATH="/home/${TEST_USER}/.nix-profile/bin:${PATH}"
ENV NIX_PATH="nixpkgs=channel:nixos-unstable"

RUN mkdir -p ~/.config/nix && \
    echo "experimental-features = nix-command flakes" > ~/.config/nix/nix.conf

COPY --chown=${TEST_USER}:${TEST_USER} . /src
WORKDIR /src

RUN ssh-keygen -t ed25519 -f tests/test-key -N "" -C "ci-test-key" -q && \
    mkdir -p ~/.ssh && \
    cp tests/test-key ~/.ssh/id_ed25519 && \
    chmod 600 ~/.ssh/id_ed25519 && \
    bash tests/encrypt-test-secrets.sh

ENV XDG_RUNTIME_DIR=/run/user/1000
USER root
RUN mkdir -p /run/user/1000 && chown ${TEST_USER}:${TEST_USER} /run/user/1000
USER ${TEST_USER}

RUN rm -f ~/.profile ~/.bashrc

RUN cd /src && nix flake update --accept-flake-config 2>/dev/null || nix flake update

RUN set -e && \
    echo "=== Nix version ===" && nix --version && \
    echo "=== Evaluating flake ===" && \
    nix flake metadata && \
    echo "=== Building home-manager config ===" && \
    nix build ".#homeConfigurations.\"${TEST_USER}@x86_64-linux\".activationPackage" --impure --no-link --print-build-logs && \
    echo "=== Activating ===" && \
    nix run ".#homeConfigurations.\"${TEST_USER}@x86_64-linux\".activationPackage" --impure && \
    echo "=== Verifying packages ===" && \
    . ~/.nix-profile/etc/profile.d/hm-session-vars.sh 2>/dev/null || true && \
    command -v git && git --version && \
    command -v curl && echo "curl: installed" && \
    command -v kubectl && echo "kubectl: installed" && \
    command -v aws && echo "awscli: installed" && \
    command -v k9s && echo "k9s: installed" && \
    command -v devenv && echo "devenv: installed" && \
    command -v direnv && echo "direnv: installed" && \
    command -v uv && echo "uv: installed" && \
    command -v eza && echo "eza: installed" && \
    command -v bat && echo "bat: installed" && \
    command -v alejandra && echo "alejandra: installed" && \
    command -v agenix && echo "agenix: installed" && \
    echo "=== Verifying .npmrc ===" && \
    test -f ~/.npmrc && echo "ok: .npmrc deployed" && \
    grep -q "nexus3.betha.com.br" ~/.npmrc && echo "ok: .npmrc has nexus registry" && \
    echo "=== Verifying .bashrc ===" && \
    test -f ~/.bashrc && echo "ok: .bashrc deployed" && \
    grep -q "HISTCONTROL" ~/.bashrc && echo "ok: .bashrc has history config" && \
    echo "=== Triggering agenix decryption ===" && \
    AGENIX_EXEC=$(grep -oP 'ExecStart=\K.*' ~/.config/systemd/user/agenix.service) && \
    eval "$AGENIX_EXEC" && \
    echo "=== Verifying decrypted secrets ===" && \
    test -f "$XDG_RUNTIME_DIR/agenix/npm-auth-token" && echo "ok: npm-auth-token decrypted" && \
    test -f "$XDG_RUNTIME_DIR/agenix/gitlab-deploy-token" && echo "ok: gitlab-deploy-token decrypted" && \
    test -f "$XDG_RUNTIME_DIR/agenix/aws-credentials" && echo "ok: aws-credentials decrypted" && \
    echo "=== Injecting npm auth token ===" && \
    INJECT_EXEC=$(grep -oP 'ExecStart=\K.*' ~/.config/systemd/user/inject-npm-auth.service) && \
    eval "$INJECT_EXEC" && \
    echo "=== Verifying .npmrc auth token ===" && \
    grep -q "_authToken" ~/.npmrc && echo "ok: .npmrc has _authToken" && \
    echo "=== DEPLOYMENT TEST PASSED ==="

CMD ["bash"]
